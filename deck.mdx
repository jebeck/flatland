import { Appear, Image } from "@mdx-deck/components"
import { Split } from "@mdx-deck/layouts"

import CodeSurfer from "code-surfer"
import oceanicNext from "prism-react-renderer/themes/oceanicNext"

import { TSNEonMNIST } from "./examples.bundle.js"
import { UMAPonMNIST } from "./examples.bundle.js"

import SingleMNISTDigit from "./components/SingleMNISTDigit"
import StitchFixLogo from "./components/StitchFixLogo"
import Team from "./components/Team"
import TeamOrg from "./components/TeamOrg"
import TwoDimsScatterPlot from "./components/TwoDimsScatterPlot"

import { code } from "@mdx-deck/themes"

import customTheme from "./theme"

export const themes = [code, customTheme]

<Image src="/assets/img/title.png"
  style={{
    alignItems: "center",
    backgroundColor: "white",
    display: "flex",
    flexDirection: "column",
    justifyContent: "center",
  }}>

# Data science in the browser:

# DX & UX

## DinosaurJS, June 20th 2019

</Image>

---

## Jana Beck

### data visualization engineer

<StitchFixLogo />

## @ Stitch Fix

---

# what's Stitch Fix?

<Split>

<img
  src=" /assets/img/stitchfix_womens_box.png"
  style={{ paddingRight: "4rem" }}
/>

<ul>
<li style={{lineHeight: 1.6}}>style profile</li>

<li style={{ lineHeight: 1.6 }}>stylist picks 5 things (a.k.a. a "fix")</li>

<li style={{ lineHeight: 1.6 }}>try on at home ğŸ </li>

<li style={{lineHeight: 1.6}}>pay ğŸ’¸ for what you keep</li>
</ul>

</Split>

---

# where's the data science? (1/2)

- warehouse assignment
- recommendation systems
- client-stylist matching
- human computation

---

# where's the data science? (2/2)

- logistics (optimization)
- demand modeling
- inventory management
- new style development

---

<Image
  src="/assets/img/supreme.png"
  style={{
    alignItems: "center",
    backgroundColor: "white",
    color: "black",
    display: "flex",
    flexDirection: "column",
    justifyContent: "center",
  }}
>

### to learn more...

[take the Stitch Fix Algo tour!](http://algorithms-tour.stitchfix.com/)

</Image>

---

# context

---

<Team />

---

<TeamOrg />

---

# (the team)

- ["full stack" data scientists](https://multithreaded.stitchfix.com/blog/2019/03/11/FullStackDS-Generalists/)
- ...but not with frontend web dev

---

# front end in Algo

- co-dev w/data scientists
- reusable React component library
  - DataWarehouseFetch
  - (generalized) Fetch
  - Save/Fetch/Delete from common data store
  - & more...
- - a wrapper around create-react-app

---

# I thought we were going to talk about data science in the browser?!

---

# dimensionality reduction

# components!

---

# t-SNE

### and

# UMAP

---

## what _is_

## âœ¨ dimensionality reduction âœ¨

## tho??? ğŸ¤”

---

| emoji | weight | calories |
| ----- | ------ | -------- |
| ğŸˆ    | 552    | 186      |
| ğŸ‡    | 2.4    | 2        |
| ğŸ‰    | 4518   | 1371     |
| ğŸŠ    | 88     | 47       |
| ğŸ‹    | 58     | 17       |

---

<TwoDimsScatterPlot />

---

| emoji | carbs | protein | fat |
| ----- | ----- | ------- | --- |
| ğŸˆ    | 8     | 0.8     | 0.2 |
| ğŸ‡    | 17    | 0.6     | 0.4 |
| ğŸ‰    | 8     | 0.6     | 0.2 |
| ğŸŠ    | 13    | 0.8     | 0.3 |
| ğŸ‹    | 9     | 1.1     | 0.3 |

---

TODO: x-y-z scatter plot

<!-- TODO: Three.js 3d scatter plot of expanded dataset -->

---

# t-SNE

### and

# UMAP

---

<Image
  src="/assets/img/MNIST_digits.png">

<div
  style={{
    alignItems: "center",
    display: "flex",
    flexDirection: "column",
    height: "100vh",
    justifyContent: "center",
    margin: 0,
    width: "100vw",
  }}
>
  <div
    style={{
      backgroundColor: "ghostwhite",
      padding: "3rem 2rem",
    }}
  >
    <h2 style={{ margin: 0 }}>some MNIST âœï¸ digits</h2>
  </div>
</div>

</Image>

---

<div
  style={{
    backgroundColor: "ghostwhite",
    padding: "3rem 2rem",
  }}
>
  <h1 style={{ margin: 0 }}>one digit</h1>
</div>

## 28 <span>&times;</span> 28 pixels

## = 28 <span>&times;</span> 28 = 784 dimensions

---

<SingleMNISTDigit />

---

<SingleMNISTDigit overlay />

---

<SingleMNISTDigit coordinates overlay />

---

<Split>

<SingleMNISTDigit coordinates highlight={[8, 7]} overlay />

<div style={{ padding: '1rem' }}>

|       | ... | 8,7   | 9,7 | ... |
| ----- | --- | ----- | --- | --- |
| img_0 | ... | **0** | 1   | ... |
| img_1 | ... | ...   | ... | ... |

</div>

</Split>

---

<Split>

<SingleMNISTDigit coordinates highlight={[9, 7]} overlay />

<div style={{ padding: '1rem' }}>

|       | ... | 8,7 | 9,7   | ... |
| ----- | --- | --- | ----- | --- |
| img_0 | ... | 0   | **1** | ... |
| img_1 | ... | ... | ...   | ... |

</div>

</Split>

---

## the @tensorflow/tfjs-tsne result

<img
  src="/assets/img/tfjs-tsne-mnist-demo.png"
  style={{
    border: "10px solid ghostwhite",
    borderRadius: "0.5rem",
    maxHeight: "65vh",
    maxWidth: "80vw",
  }}
/>

---

<img src="/assets/img/better_living_thru.png" />

---

<img src="/assets/img/better_living_thru.png" />

<div style={{ position: "fixed", bottom: "25rem", right: "27.5rem" }}>
  <h1 style={{ color: "#5DB968", fontStyle: "italic" }}>
    <span role="img" aria-label="computer emoji">
      ğŸ’»
    </span>
    &nbsp;&nbsp;<span style={{ textDecoration: "underline" }}>compute</span> components!
  </h1>
</div>

---

# UX concerns

<ul>
  <Appear>
    <li>minimize load on users' compute resources</li>
    <li>minimize compute time</li>
  </Appear>
</ul>

<Split>

<img src="/assets/img/computer-on-fire.gif" style={{ height: "320px" }} />

<img src="/assets/img/102.gif" style={{ height: "320px" }} />

</Split>

---

# ...how?

<ul>
  <Appear>
    <li>
      compute on the GPU
      <ul>
        <li>
          in OffscreenCanvas in a Web Worker{" "}
          <span role="img" aria-label="sweat smile emoji">
            ğŸ˜…
          </span>
        </li>
      </ul>
    </li>
    <li>
      caching{" "}
      <small style={{ fontSize: "24px" }}>
        (yay, one of the two hard problems, along with naming and off-by-one
        errors)
      </small>
    </li>
  </Appear>
</ul>

---

# ğŸ‘·â€â™€ï¸ Web Workers ğŸ‘·

<ul>
  <Appear>
    <li>concurrency in JavaScript!</li>
    <li>separate execution from your app bundle</li>
    <li>no DOM</li>
    <li>pass messages back-and-forth</li>
  </Appear>
</ul>

---

# ğŸ‘·â€â™€ï¸ Web Workers ğŸ‘·

<ul>
  <li>concurrency in JavaScript!</li>
  <li>separate execution from your app bundle</li>
  <li>no DOM</li>
  <li style={{ fontWeight: "bold" }}>
    pass{" "}
    <a
      href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm"
      style={{ fontStyle: "italic", textDecoration: "underline" }}
    >
      serializable
    </a>{" "}
    messages back-and-forth
  </li>
</ul>

---

# what's serializable?

- primitive types
- `Date`s
- `Blob`s
- `ArrayBuffer`s
- etc.

---

# what's **not** serializable?

- DOM nodes
- `Error`s
- functions

---

# Web Worker template

<div style={{ maxHeight: '65vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/web-worker.js").default}
  theme={oceanicNext}
/>

</div>

---

# Web Worker in React

<div style={{ maxHeight: '75vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/react-worker.js").default}
  theme={oceanicNext}
/>

</div>

---

<div style={{ maxHeight: '75vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/react-worker.js").default}
  step={{ lines: [1] }}
  theme={oceanicNext}
/>

</div>

---

<div style={{ maxHeight: '75vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/react-worker.js").default}
  step={{ range: [4, 10] }}
  theme={oceanicNext}
/>

</div>

---

<div style={{ maxHeight: '75vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/react-worker.js").default}
  step={{ range: [12, 15] }}
  theme={oceanicNext}
/>

</div>

---

<div style={{ maxHeight: '75vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/react-worker.js").default}
  step={{ range: [16, 19] }}
  theme={oceanicNext}
/>

</div>

---

# how to bundle a Worker

- Webpack
  - worker-loader
  - workerize-loader
  - ğŸ˜• (no create-react-app support, yet)
    - react-app-rewired = modify CRA Webpack build w/o ejecting
- rollup
  - â“plugin may be out-of-date

---

TODO: OffscreenCanvas

---

# caching

<ul>
  <Appear>
    <li>data doesn't change super often</li>
    <li>but an escape hatch is a good idea</li>
  </Appear>
</ul>

---

# simple caching

# & invalidation

- object-hash on the data
- hash serves as `localStorage` key
- `cache` is a Boolean prop on the `<Compute.../>` components

<Appear>

- ğŸ¤« the secret is you always _store_ results in the cache
- (you just don't always _pull_ results from the cache)

</Appear>

---

# caching & invalidation

## in the

# React component lifecycle

---

<div style={{ maxHeight: '75vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/react-caching.js").default}
  step={{ range: [2, 4] }}
  theme={oceanicNext}
/>

</div>

---

<div style={{ maxHeight: '75vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/react-caching.js").default}
  step={{ range: [6, 21] }}
  theme={oceanicNext}
/>

</div>

---

<div style={{ maxHeight: '75vh' }}>

<CodeSurfer
  code={require("!raw-loader!./assets/code/react-caching.js").default}
  step={{ range: [23, 32] }}
  theme={oceanicNext}
/>

</div>

---

# DX concerns

<Appear>
  <div>
    same, TBH{" "}
    <span role="img" aria-label="upside-down smile emoji">
      ğŸ™ƒ
    </span>
  </div>
  <div>+ reusability via declarative componentization</div>
</Appear>

---

# DX concerns

- Workers = good for dev
  - still a challenge! <span role='img' aria-label='laptop emoji'>ğŸ’»</span> on <span role='img' aria-label='fire emoji'>ğŸ”¥</span>
- caching = good for iterating on _presentation_

---

# ğŸ‰ ğŸ‰ ğŸ‰

# demos!

# ğŸ‰ ğŸ‰ ğŸ‰

---

# `<ComputeTSNE/>` on MNIST

---

<TSNEonMNIST cache iterations={1000} />

---

# `<ComputeUMAP/>` on MNIST

---

<UMAPonMNIST />

---

# Stitch Fix demos

### (not in deck)
