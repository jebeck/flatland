import { code } from "@mdx-deck/themes"
import { Appear, Head, Horizontal, Image, Split } from "mdx-deck"

import { CodeSurfer } from "code-surfer"
import { nightOwl } from "@code-surfer/themes"
import getRandomlyDistributedColors from "./utils/getRandomlyDistributedColors"
import getUniformlyDistributedColors from "./utils/getUniformlyDistributedColors"
import getRandomColorsFromAllSpaces from "./utils/getRandomColorsFromAllSpaces"

import AnimateToUMAPColorSpace from "./components/AnimateToUMAPColorSpace"
import AnimateToUMAPMNISTDigits from './components/LoadableAnimateToUMAPMNISTDigits'
import ColorSpace from "./components/LoadableColorSpace"
import Credit from "./components/Credit"
import InteractiveColorSpace from "./components/InteractiveColorSpace"
import InteractiveUMAPColorSpace from "./components/InteractiveUMAPColorSpace"
import SingleMNISTDigit from './components/SingleMNISTDigit'
import SphereVisitsFlatland, {
  startingCameraPosition,
} from "./components/SphereVisitsFlatland"
import StitchFixLogo from "./components/StitchFixLogo"
import SVGContainer from "./components/SVGContainer"
import Three from "./components/LoadableThree"
import { List, Subtitle, Title } from "./styled"

import equalEarth from "./images/Equal-Earth.png"
import flatlandBook from "./images/Flatland-book.jpg"
import flatlandTitleAuthor from "./images/Flatland-title-author.png"
import mercator from "./images/Mercator.png"
import mnistDigits from './images/MNIST_digits.png'
import offscreenCanvas from "./images/OffscreenCanvas.png"
import tensorFlowJs from "./images/TensorFlowjs.png"
import umapJs from "./images/umap-js.png"
import watermansButterfly from "./images/Watermans-Butterfly.png"
import worldWideWeb from "./images/WorldWideWeb.png"

import Browser from "./svg/Browser"
import BrowserWithMainThread from "./svg/BrowserWithMainThread"
import MainAndWorkers from "./svg/MainAndWorkers"
import Flatland1 from "./svg/Flatland1"
import Flatland2 from "./svg/Flatland2"

import customTheme from "./theme"
export const themes = [code, customTheme]
const sphereVisitCamera = {
  fov: 75,
  near: 0.1,
  far: 2000,
  position: startingCameraPosition,
}

<Head>
  <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah&display=swap" rel="stylesheet" />
  <title>escaping flatland</title>
</Head>

<Title>
  <h1>escaping flatland</h1>
  <Subtitle>
    <h2>a romance</h2>
    <h3>of</h3>
    <h2>data science</h2>
    <h2>in the browser</h2>
  </Subtitle>
</Title>

---

## Jana Beck

### data visualization engineer

<StitchFixLogo />

## @ Stitch Fix

---

<Subtitle>
  <h2>a romance</h2>
  <h3>of</h3>
  <h2>data science</h2>
  <h2>in the browser</h2>
</Subtitle>

---

<Title>
  <h1>dimensionality reduction</h1>
</Title>

---

<img src={mercator} style="max-height: 90vh;" />
<Credit
  asset="Mercator Projection"
  author="Mike Bostock"
  link="https://observablehq.com/@d3/mercator?collection=@d3/d3-geo"
/>

---

<img src={equalEarth} style="max-width: 90vw;" />
<Credit
  asset="Equal Earth Projection"
  author="Mike Bostock"
  link="https://observablehq.com/@d3/equal-earth?collection=@d3/d3-geo"
/>

---

<img src={watermansButterfly} style="max-height: 90vh;" />
<Credit
  asset="Waterman's Butterfly Map Projection"
  author="Mike Bostock"
  link="https://observablehq.com/@d3/watermans-butterfly?collection=@d3/d3-geo-projection"
/>

---

<Title>
  <h1>U M A P</h1>
  <h2>Uniform Manifold Approximation & Projection</h2>
</Title>

---

<div>

  | color | r | g | b |
  | --- | --- | --- | --- |
  | <span style={{color: 'black', fontWeight: 'bold', textShadow: '0px 0px 5px #aaa'}}>black</span> | 0 | 0 | 0 |
  | <span style={{color: 'white', fontWeight: 'bold', textShadow: '0px 0px 5px #aaa'}}>white</span> | 255 | 255 | 255 |
  | <span style={{color: 'red', fontWeight: 'bold', textShadow: '0px 0px 5px #aaa'}}>red</span> | 255 | 0 | 0 |
  | <span style={{color: 'green', fontWeight: 'bold', textShadow: '0px 0px 5px #aaa'}}>green</span> | 0 | 255 | 0 |
  | <span style={{color: 'blue', fontWeight: 'bold', textShadow: '0px 0px 5px #aaa'}}>blue</span> | 0 | 0 | 255 |

</div>

---

<AnimateToUMAPColorSpace {...getUniformlyDistributedColors.rgb(13)} />

---

<AnimateToUMAPColorSpace {...getUniformlyDistributedColors.hsl(13)} />

---

<img src={mnistDigits} style={{opacity: '12.5%', position: 'absolute', top: '5vh', height: '90vh', maxWidth: '90vw'}}/>
<Title>
  <h1>the MNIST digits dataset</h1>
</Title>

---

# one digit

## 10 <span>&times;</span> 10 pixels

## = 10 <span>&times;</span> 10 = 100 dimensions

---

<SingleMNISTDigit />

---

<SingleMNISTDigit overlay />

---

<SingleMNISTDigit coordinates overlay />

---

<Split>
  <SingleMNISTDigit coordinates highlight={[2,2]} overlay />
  <div style={{ padding: '1rem' }}>

  |       | ... | 2,2   | 3,2 |
  | ----- | --- | ----- | --- |
  | img_0 | ... | <span style={{color: 'white', fontWeight: 'bold'}}>0</span> | 0.82573   |
  | img_1 | ... | ...   | ... |

  </div>
</Split>

---

<Split>
  <SingleMNISTDigit coordinates highlight={[3,2]} overlay />
  <div style={{ padding: '1rem' }}>

  |       | ... | 2,2 | 3,2   |
  | ----- | --- | --- | ----- |
  | img_0 | ... | 0   | <span style={{color: 'white', fontWeight: 'bold'}}>0.82573</span> |
  | img_1 | ... | ... | ...   |

  </div>
</Split>

---

<AnimateToUMAPMNISTDigits/>

---

<img src={flatlandBook} style="max-width: 90vw;" />

---

# edwin abbott abbott

---

<img src={flatlandTitleAuthor} style="max-width: 90vw;" />

---

<SVGContainer>
  <Flatland1 />
</SVGContainer>

---

<SVGContainer>
  <Flatland2 />
</SVGContainer>

---

<Three camera={sphereVisitCamera}>
  <SphereVisitsFlatland />
</Three>

---

<SVGContainer>
  <Browser />
</SVGContainer>

---

<img src={worldWideWeb} style="max-height: 90vh;" />

---

<img src={tensorFlowJs} style="max-height: 90vh;" />

---

<img src={umapJs} style="max-height: 90vh;" />

---

<SVGContainer>
  <BrowserWithMainThread />
</SVGContainer>

---

<SVGContainer>
  <Browser>
    <MainAndWorkers />
  </Browser>
</SVGContainer>

---

# üë∑üèæ‚Äç‚ôÄÔ∏è Web Workers üë∑üèª

<a
  href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers"
  rel="noopener noreferrer"
  target="_blank"
>
  (MDN page)
</a>

---

<Horizontal>
  <List>
    <li>‚úÖ&nbsp;XHR</li>
    <li>‚úÖ&nbsp;self</li>
  </List>
  <List>
    <li>‚úñÔ∏è&nbsp;DOM</li>
    <li>‚úñÔ∏è&nbsp;window</li>
  </List>
</Horizontal>

---

# data transfer

## ‚úâÔ∏è ‚ÜîÔ∏è ‚úâÔ∏è

## via message passing

---

<List fontSize="4rem">
  <li>data is copied, not shared</li>
  <li>and serialized/deserialized</li>
  <li>
    ...via&nbsp;
    <a
      href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm"
      rel="noopener noreferrer"
      target="_blank"
    >
      structured cloning
    </a>
  </li>
</List>

---

# what's serializable?

---

<Split>
  <List fontSize="4rem">
    <li>‚úÖ&nbsp;primitive&nbsp;types</li>
    <li>‚úÖ&nbsp;Date</li>
    <li>‚úÖ&nbsp;Blob</li>
    <li>‚úÖ&nbsp;ArrayBuffer</li>
  </List>
  <List fontSize="4rem">
    <li>‚úñÔ∏è&nbsp;DOM nodes</li>
    <li>‚úñÔ∏è&nbsp;Error</li>
    <li>‚úñÔ∏è&nbsp;functions</li>
  </List>
</Split>

---

<CodeSurfer theme={nightOwl}>

  ```js file=./code/worker-template.js title="worker template"
  ```

</CodeSurfer>

---

<CodeSurfer theme={nightOwl}>

  ```js file=./code/app-template.js title="app-side template"
  ```

</CodeSurfer>

---

# toolchain support

- ‚úÖ&nbsp;Webpack

  - worker-loader (\*.worker.js)
  - workerize-loader

- ‚úÖ&nbsp;Parcel
- (‚ùì) rollup

---

# there's more! üòÆ

<List fontSize="4.5rem">
  <li>
    <a
      href="https://developers.google.com/web/updates/2011/12/Transferable-Objects-Lightning-Fast"
      rel="noopener noreferrer"
      target="_blank"
    >
      transferable objects
    </a>
  </li>
  <li>
    <a
      href="https://developer.mozilla.org/en-US/docs/Web/API/OffscreenCanvas"
      rel="noopener noreferrer"
      target="_blank"
    >
      OffscreenCanvas
    </a>
  </li>
</List>

---

# transferable objects

<List fontSize="4.5rem">
  <li>zero copy</li>
  <li>‚âà pass by ref</li>
</List>

---

<CodeSurfer theme={nightOwl}>

  ```js file=./code/transferable-objects.js title="transferable objects"
  ```

</CodeSurfer>

---

<img src={offscreenCanvas} style="max-height: 90vh;" />

---

# üë∑üèæ‚Äç‚ôÄÔ∏è Workers in action! üë∑üèª

---

