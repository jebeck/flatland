import { code } from "@mdx-deck/themes"
import { Appear, Head, Horizontal, Image } from "mdx-deck"

import { CodeSurfer } from "code-surfer"
import { nightOwl } from "@code-surfer/themes"
import { ChromePicker } from "react-color"

import getRandomlyDistributedColors from "./utils/getRandomlyDistributedColors"
import getUniformlyDistributedColors from "./utils/getUniformlyDistributedColors"
import getRandomColorsFromAllSpaces from "./utils/getRandomColorsFromAllSpaces"

import Credit from "./components/Credit"
import InteractiveColorSpace from "./components/InteractiveColorSpace"
import InteractiveUMAPColorSpace from "./components/InteractiveUMAPColorSpace"
import ColorSpace from "./components/LoadableColorSpace"
import SphereVisitsFlatland, {
  startingCameraPosition,
} from "./components/SphereVisitsFlatland"
import StitchFixLogo from "./components/StitchFixLogo"
import SVGContainer from "./components/SVGContainer"
import Three from "./components/LoadableThree"
import { List, ScaledUpChromePicker, Subtitle, Title } from "./styled"

import equalEarth from "./images/Equal-Earth.png"
import flatlandBook from "./images/Flatland-book.jpg"
import flatlandTitleAuthor from "./images/Flatland-title-author.png"
import mercator from "./images/Mercator.png"
import offscreenCanvas from "./images/OffscreenCanvas.png"
import tensorFlowJs from "./images/TensorFlowjs.png"
import umapJs from "./images/umap-js.png"
import watermansButterfly from "./images/Watermans-Butterfly.png"
import worldWideWeb from "./images/WorldWideWeb.png"

import Browser from "./svg/Browser"
import BrowserWithMainThread from "./svg/BrowserWithMainThread"
import MainAndWorkers from "./svg/MainAndWorkers"
import Flatland1 from "./svg/Flatland1"
import Flatland2 from "./svg/Flatland2"

import customTheme from "./theme"
export const themes = [code, customTheme]
const sphereVisitCamera = {
  fov: 75,
  near: 0.1,
  far: 2000,
  position: startingCameraPosition,
}

<Head>
  <title>escaping flatland</title>
</Head>

---

<Title>
  <h1>escaping flatland</h1>
  <Subtitle>
    <h2>a romance</h2>
    <h3>of</h3>
    <h2>data science</h2>
    <h2>in the browser</h2>
  </Subtitle>
</Title>

---

## Jana Beck

### data visualization engineer

<StitchFixLogo />

## @ Stitch Fix

---

<Subtitle>
  <h2>a romance</h2>
  <h3>of</h3>
  <h2>data science</h2>
  <h2>in the browser</h2>
</Subtitle>

---

<Title>
  <h1>dimensionality reduction</h1>
</Title>

---

<Title>
  <h1>3 to 2</h1>
  <Appear>
    <h1>= maps!</h1>
  </Appear>
</Title>

---

<img src={mercator} style="max-height: 90vh;" />
<Credit
  asset="Mercator Projection"
  author="Mike Bostock"
  link="https://observablehq.com/@d3/mercator?collection=@d3/d3-geo"
/>

---

<img src={equalEarth} style="max-width: 90vw;" />
<Credit
  asset="Equal Earth Projection"
  author="Mike Bostock"
  link="https://observablehq.com/@d3/equal-earth?collection=@d3/d3-geo"
/>

---

<img src={watermansButterfly} style="max-height: 90vh;" />
<Credit
  asset="Waterman's Butterfly Map Projection"
  author="Mike Bostock"
  link="https://observablehq.com/@d3/watermans-butterfly?collection=@d3/d3-geo-projection"
/>

---

<img src={flatlandBook} style="max-width: 90vw;" />

---

<img src={flatlandTitleAuthor} style="max-width: 90vw;" />

---

<SVGContainer>
  <Flatland1 />
</SVGContainer>

---

<SVGContainer>
  <Flatland2 />
</SVGContainer>

---

<Three camera={sphereVisitCamera}>
  <SphereVisitsFlatland />
</Three>

---

<SVGContainer>
  <Browser />
</SVGContainer>

---

<img src={worldWideWeb} style="max-height: 90vh;" />

---

<img src={tensorFlowJs} style="max-height: 90vh;" />

---

<img src={umapJs} style="max-height: 90vh;" />

---

<SVGContainer>
  <BrowserWithMainThread />
</SVGContainer>

---

<SVGContainer>
  <Browser>
    <MainAndWorkers />
  </Browser>
</SVGContainer>

---

# üë∑üèæ‚Äç‚ôÄÔ∏è Web Workers üë∑üèª

<a
  href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers"
  rel="noopener noreferrer"
  target="_blank"
>
  (MDN page)
</a>

---

<Horizontal>
  <List>
    <li>‚úÖ&nbsp;XHR</li>
    <li>‚úÖ&nbsp;self</li>
  </List>
  <List>
    <li>‚úñÔ∏è&nbsp;DOM</li>
    <li>‚úñÔ∏è&nbsp;window</li>
  </List>
</Horizontal>

---

# data transfer

## ‚úâÔ∏è ‚ÜîÔ∏è ‚úâÔ∏è

## via message passing

---

<List fontSize="4rem">
  <li>data is copied, not shared</li>
  <li>and serialized/deserialized</li>
  <li>
    ...via&nbsp;
    <a
      href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm"
      rel="noopener noreferrer"
      target="_blank"
    >
      structured cloning
    </a>
  </li>
</List>

---

# what's serializable?

---

<Split>
  <List fontSize="4rem">
    <li>‚úÖ&nbsp;primitive&nbsp;types</li>
    <li>‚úÖ&nbsp;Date</li>
    <li>‚úÖ&nbsp;Blob</li>
    <li>‚úÖ&nbsp;ArrayBuffer</li>
  </List>
  <List fontSize="4rem">
    <li>‚úñÔ∏è&nbsp;DOM nodes</li>
    <li>‚úñÔ∏è&nbsp;Error</li>
    <li>‚úñÔ∏è&nbsp;functions</li>
  </List>
</Split>

---

<CodeSurfer theme={nightOwl}>

  ```js file=./code/worker-template.js title="worker template"
  ```

</CodeSurfer>

---

<CodeSurfer theme={nightOwl}>

  ```js file=./code/app-template.js title="app-side template"
  ```

</CodeSurfer>

---

# toolchain support

- ‚úÖ&nbsp;Webpack

  - worker-loader (\*.worker.js)
  - workerize-loader

- ‚úÖ&nbsp;Parcel
- (‚ùì) rollup

---

# there's more! üòÆ

<List fontSize="4.5rem">
  <li>
    <a
      href="https://developers.google.com/web/updates/2011/12/Transferable-Objects-Lightning-Fast"
      rel="noopener noreferrer"
      target="_blank"
    >
      transferable objects
    </a>
  </li>
  <li>
    <a
      href="https://developer.mozilla.org/en-US/docs/Web/API/OffscreenCanvas"
      rel="noopener noreferrer"
      target="_blank"
    >
      OffscreenCanvas
    </a>
  </li>
</List>

---

# transferable objects

<List fontSize="4.5rem">
  <li>zero copy</li>
  <li>‚âà pass by ref</li>
</List>

---

<CodeSurfer theme={nightOwl}>

  ```js file=./code/transferable-objects.js title="transferable objects"
  ```

</CodeSurfer>

---

<img src={offscreenCanvas} style="max-height: 90vh;" />

---

# üë∑üèæ‚Äç‚ôÄÔ∏è Workers in action! üë∑üèª

---

<Title>
  <h1>dimensionality reduction</h1>
</Title>

## for visualization

---

<List>
  <li>
    t-SNE&nbsp;<small>(t-Distributed Stochastic Neighbor Embedding)</small>
  </li>
  <li>
    <small>and</small>
  </li>
  <li>
    UMAP&nbsp;<small>(Uniform Manifold Approximation and Projection)</small>
  </li>
</List>

---

<List>
  <li style="color: #4ECEC9;">rgb(78,206,201)</li>
  <li style="color: #4ECEC9;">hsl(0.49, 57%, 56%)</li>
  <li style="color: #4ECEC9;">lab(76, -36, -8)</li>
</List>

---

<ScaledUpChromePicker>
  <ChromePicker color="#4ECEC9" disableAlpha />
</ScaledUpChromePicker>

---

<Three>
  <ColorSpace
    cameraPosition={[90, 50, 75]}
    orbitTarget={[0, 0, 25]}
    {...getUniformlyDistributedColors.hsl(15)}
  />
</Three>

---

<Three>
  <ColorSpace
    cameraPosition={[90, 50, 75]}
    orbitTarget={[0, 0, 25]}
    {...getUniformlyDistributedColors.rgb(15)}
  />
</Three>

---

<Three>
  <ColorSpace
    cameraPosition={[90, 50, 75]}
    orbitTarget={[0, 0, 25]}
    {...getUniformlyDistributedColors.lab(15)}
  />
</Three>

---

<InteractiveColorSpace {...getUniformlyDistributedColors.lab(15)} />

---

<InteractiveUMAPColorSpace {...getRandomlyDistributedColors.hsl(2000)} />

---

<InteractiveUMAPColorSpace {...getRandomlyDistributedColors.rgb(2000)} />

---

<InteractiveUMAPColorSpace {...getRandomlyDistributedColors.lab(2000)} />

---

<InteractiveUMAPColorSpace
  data={getRandomColorsFromAllSpaces(3000)}
  dimensions={3}
  exclude={["color", "r", "g", "b"]}
  space="rgb"
/>
